<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Registo Horário</title>
<style>
  body {
    font-family: sans-serif;
    max-width: 480px;
    margin: 0 auto;
    padding: 1rem;
    text-align: center;
  }
  .employee-button {
    width: 90%;
    height: 80px;
    margin: 15px auto;
    font-size: 24px;
    border-radius: 10px;
    background-color: #4285f4;
    color: white;
    border: none;
  }
  .employee-button.active {
    background-color: #34a853;
  }
  .status {
    margin-top: 20px;
    padding: 10px;
    border-radius: 5px;
    font-weight: bold;
  }
  .active {
    background-color: #d4edda;
    color: #155724;
  }
  #loading {
    display: none;
    margin: 20px auto;
    font-style: italic;
  }
  #hidden-iframe {
    display: none;
    width: 0;
    height: 0;
    border: 0;
  }
</style>

<h1>Registo Horário - Estofagem</h1>
<div id="employee-buttons">
  <button class="employee-button" data-name="Antónia">Antónia</button>
  <button class="employee-button" data-name="Diana">Diana</button>
  <button class="employee-button" data-name="Teresa">Teresa</button>
</div>
<div id="status" class="status"></div>
<div id="loading">A processar...</div>

<iframe id="hidden-iframe" name="hidden-iframe"></iframe>

<form id="data-form"
      action="https://script.google.com/macros/s/AKfycbzmELss6Z2Q8kp65Y5JOxFrqlVulmf_hWDrynjuw57zW3pVBtnnN5juovfbmYjYwQa7/exec"
      target="hidden-iframe"
      method="POST"
      style="display:none;">
  <input type="hidden" id="form-data" name="data" value="">
</form>

<script>
(function() {
  var URL = "https://script.google.com/macros/s/AKfycbzmELss6Z2Q8kp65Y5JOxFrqlVulmf_hWDrynjuw57zW3pVBtnnN5juovfbmYjYwQa7/exec";
  var buttons = document.querySelectorAll('.employee-button');
  var statusDiv = document.getElementById('status');
  var loadingDiv = document.getElementById('loading');
  var dataForm = document.getElementById('data-form');
  var formData = document.getElementById('form-data');
  var hiddenIframe = document.getElementById('hidden-iframe');

  var breakPeriods = [
    { start: '10:00', end: '10:10' },
    { start: '12:00', end: '13:00' }
  ];

  var employees = {};

  function loadState() {
    try {
      var savedState = localStorage.getItem('employeeState');
      if (savedState) {
        employees = JSON.parse(savedState);
        updateButtonsState();
      }
    } catch(e) {
      employees = {};
      localStorage.removeItem('employeeState');
    }
  }

  function saveState() {
    try {
      localStorage.setItem('employeeState', JSON.stringify(employees));
    } catch(e) {
      updateStatus('Erro ao salvar estado: ' + e.message);
    }
  }

  function updateButtonsState() {
    for (var i = 0; i < buttons.length; i++) {
      var name = buttons[i].getAttribute('data-name');
      if (employees[name] && employees[name].isWorking) {
        buttons[i].className = 'employee-button active';
      } else {
        buttons[i].className = 'employee-button';
      }
    }
  }

  function setupButtons() {
    for (var i = 0; i < buttons.length; i++) {
      buttons[i].onclick = handleButtonClick;
    }
  }

  function handleButtonClick() {
    var name = this.getAttribute('data-name');
    var isWorking = employees[name] && employees[name].isWorking;

    if (isWorking) {
      if (confirm('Quer terminar o período de trabalho na secção de estofagem?')) {
        endWork(name);
      }
    } else {
      if (confirm('Quer iniciar o período de trabalho na secção de estofagem?')) {
        startWork(name);
      }
    }
  }

  function startWork(name) {
    var now = new Date();
    if (!employees[name]) employees[name] = {};
    employees[name].isWorking = true;
    employees[name].startTime = now.toISOString();
    saveState();
    updateButtonsState();
    updateStatus(name + ' iniciou trabalho às ' + formatTime(now));
  }

  function endWork(name) {
    if (!employees[name] || !employees[name].isWorking) {
      updateStatus('Erro: ' + name + ' não está em período de trabalho');
      return;
    }

    var now = new Date();
    var startTime = new Date(employees[name].startTime);
    var data = {
      funcionario: name,
      secao: 'Estofagem',
      inicio: formatTime(startTime),
      fim: formatTime(now),
      duracao: calculateWorkDuration(startTime, now)
    };

    employees[name].isWorking = false;
    saveState();
    updateButtonsState();
    updateStatus(name + ' terminou trabalho às ' + formatTime(now) + '. A enviar dados...');
    sendDataViaForm(data);
  }

  function calculateWorkDuration(start, end) {
    var totalMinutes = 0;
    var current = new Date(start);
    while (current < end) {
      var currentTimeStr = formatTime(current);
      var isBreakTime = breakPeriods.some(function(b) {
        return currentTimeStr >= b.start && currentTimeStr < b.end;
      });
      if (!isBreakTime) totalMinutes++;
      current.setTime(current.getTime() + 60000);
    }
    return (totalMinutes / 60).toFixed(2);
  }

  function formatTime(date) {
    var hours = date.getHours();
    var minutes = date.getMinutes();
    return (hours < 10 ? '0' : '') + hours + ':' + (minutes < 10 ? '0' : '') + minutes;
  }

  function sendDataViaForm(data) {
    saveOfflineData(data);
    loadingDiv.style.display = 'block';
    var timestamp = new Date().getTime();
    dataForm.action = URL + '?t=' + timestamp;
    hiddenIframe.onload = function() {
      loadingDiv.style.display = 'none';
      updateStatus('Registo guardado com sucesso!');
      removeFromOfflineData(data);
    };
    setTimeout(function() {
      if (loadingDiv.style.display === 'block') {
        loadingDiv.style.display = 'none';
        updateStatus('Tempo esgotado. Dados guardados localmente.');
      }
    }, 5000);
    formData.value = JSON.stringify(data);
    dataForm.submit();
  }

  function saveOfflineData(data) {
    try {
      var offlineData = localStorage.getItem('offlineData');
      var dataArray = offlineData ? JSON.parse(offlineData) : [];
      dataArray.push(data);
      localStorage.setItem('offlineData', JSON.stringify(dataArray));
    } catch(e) {
      updateStatus('Erro ao salvar dados offline: ' + e.message);
    }
  }

  function removeFromOfflineData(data) {
    try {
      var offlineData = localStorage.getItem('offlineData');
      if (!offlineData) return;
      var dataArray = JSON.parse(offlineData);
      var newArray = dataArray.filter(function(item) {
        return !(item.funcionario === data.funcionario && item.inicio === data.inicio && item.fim === data.fim);
      });
      localStorage.setItem('offlineData', JSON.stringify(newArray));
    } catch(e) {
      updateStatus('Erro ao remover dados offline: ' + e.message);
    }
  }

  function trySendOfflineData() {
    try {
      var offlineData = localStorage.getItem('offlineData');
      if (!offlineData) return;
      var dataArray = JSON.parse(offlineData);
      if (dataArray.length > 0) {
        updateStatus('Tentando enviar dados offline...');
        sendDataViaForm(dataArray[0]);
      }
    } catch(e) {
      updateStatus('Erro ao processar dados offline: ' + e.message);
    }
  }

  function updateStatus(message) {
    statusDiv.textContent = message;
    statusDiv.className = 'status active';
    setTimeout(function() {
      statusDiv.className = 'status';
    }, 5000);
  }

  loadState();
  setupButtons();
  setInterval(trySendOfflineData, 60000);
})();
</script>
