<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Registo Horário</title>
<style>
  body {
    font-family: sans-serif;
    max-width: 480px;
    margin: 0 auto;
    padding: 1rem;
    text-align: center;
  }
  .employee-button {
    width: 90%;
    height: 80px;
    margin: 15px auto;
    font-size: 24px;
    border-radius: 10px;
    background-color: #4285f4;
    color: white;
    border: none;
  }
  .employee-button.active {
    background-color: #34a853; /* Verde quando ativo */
  }
  .status {
    margin-top: 20px;
    padding: 10px;
    border-radius: 5px;
    font-weight: bold;
  }
  .active {
    background-color: #d4edda;
    color: #155724;
  }
  #loading {
    display: none;
    margin: 20px auto;
    font-style: italic;
  }
</style>

<h1>Registo Horário - Estofagem</h1>
<div id="employee-buttons">
  <button class="employee-button" data-name="Antónia">Antónia</button>
  <button class="employee-button" data-name="Diana">Diana</button>
  <button class="employee-button" data-name="Teresa">Teresa</button>
</div>
<div id="status" class="status"></div>
<div id="loading">A processar...</div>

<script>
(function() {
  // URL do Google Apps Script
  var URL = "https://script.google.com/macros/s/AKfycbxbv3rV0rBWHvBuypZGg-uCk0JRqg5dDeHJgiz1383B_JtgwndA1HON2r83xfJJ76Ul/exec";
  
  // Referência aos elementos
  var buttons = document.querySelectorAll('.employee-button');
  var statusDiv = document.getElementById('status');
  var loadingDiv = document.getElementById('loading');
  
  // Períodos de pausa (formato 24h)
  var breakPeriods = [
    { start: '10:00', end: '10:10' },
    { start: '12:00', end: '13:00' }
  ];
  
  // Inicializar estado dos funcionários
  var employees = {};
  
  // Carregar estado do localStorage
  function loadState() {
    var savedState = localStorage.getItem('employeeState');
    if (savedState) {
      try {
        employees = JSON.parse(savedState);
        updateButtonsState(); // Atualizar visual dos botões
      } catch(e) {
        console.error("Erro ao carregar estado:", e);
        employees = {};
      }
    }
  }
  
  // Salvar estado no localStorage
  function saveState() {
    localStorage.setItem('employeeState', JSON.stringify(employees));
  }
  
  // Atualizar o estado visual dos botões
  function updateButtonsState() {
    for (var i = 0; i < buttons.length; i++) {
      var name = buttons[i].getAttribute('data-name');
      if (employees[name] && employees[name].isWorking) {
        buttons[i].classList.add('active');
      } else {
        buttons[i].classList.remove('active');
      }
    }
  }
  
  // Configurar botões
  function setupButtons() {
    for (var i = 0; i < buttons.length; i++) {
      buttons[i].addEventListener('click', handleButtonClick);
    }
  }
  
  // Manipular clique no botão
  function handleButtonClick() {
    var name = this.getAttribute('data-name');
    var isWorking = employees[name] && employees[name].isWorking;
    
    if (isWorking) {
      // Funcionário está a trabalhar, confirmar saída
      if (confirm('Quer terminar o período de trabalho na secção de estofagem?')) {
        endWork(name);
      }
    } else {
      // Funcionário não está a trabalhar, confirmar entrada
      if (confirm('Quer iniciar o período de trabalho na secção de estofagem?')) {
        startWork(name);
      }
    }
  }
  
  // Iniciar período de trabalho
  function startWork(name) {
    var now = new Date();
    employees[name] = {
      isWorking: true,
      startTime: now.toISOString()
    };
    saveState();
    updateButtonsState(); // Atualizar visual dos botões
    updateStatus(name + ' iniciou trabalho às ' + formatTime(now));
  }
  
  // Terminar período de trabalho
  function endWork(name) {
    var now = new Date();
    var startTime = new Date(employees[name].startTime);
    
    var data = {
      funcionario: name,
      secao: 'Estofagem',
      inicio: formatTime(startTime),
      fim: formatTime(now),
      duracao: calculateWorkDuration(startTime, now)
    };
    
    // Enviar dados para o servidor
    sendData(data);
    
    // Atualizar estado
    employees[name].isWorking = false;
    saveState();
    updateButtonsState(); // Atualizar visual dos botões
    
    updateStatus(name + ' terminou trabalho às ' + formatTime(now));
  }
  
  // Calcular duração do trabalho excluindo pausas
  function calculateWorkDuration(start, end) {
    var totalMinutes = 0;
    var current = new Date(start);
    
    while (current < end) {
      var currentTimeStr = formatTime(current);
      var isBreakTime = false;
      
      // Verificar se o momento atual está em período de pausa
      for (var i = 0; i < breakPeriods.length; i++) {
        if (currentTimeStr >= breakPeriods[i].start && currentTimeStr < breakPeriods[i].end) {
          isBreakTime = true;
          break;
        }
      }
      
      if (!isBreakTime) {
        totalMinutes++;
      }
      
      // Avançar um minuto
      current.setTime(current.getTime() + 60000);
    }
    
    // Converter minutos para horas decimais
    return (totalMinutes / 60).toFixed(2);
  }
  
  // Formatar hora como HH:MM
  function formatTime(date) {
    var hours = date.getHours().toString().padStart(2, '0');
    var minutes = date.getMinutes().toString().padStart(2, '0');
    return hours + ':' + minutes;
  }
  
  // Enviar dados para o servidor - Método principal
  function sendData(data) {
    // Salvar dados offline primeiro (garantia)
    saveOfflineData(data);
    
    // Mostrar indicador de carregamento
    loadingDiv.style.display = 'block';
    
    // Tentar primeiro com XMLHttpRequest (funciona em navegadores modernos)
    try {
      var xhr = new XMLHttpRequest();
      xhr.open('POST', URL, true);
      xhr.setRequestHeader('Content-Type', 'text/plain');
      
      xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
          loadingDiv.style.display = 'none';
          
          if (xhr.status === 200) {
            updateStatus('Registo guardado com sucesso!');
            removeFromOfflineData(data);
          } else {
            updateStatus('Erro ao guardar registo. Tentando método alternativo...');
            // Tentar método alternativo
            sendDataAlternative(data);
          }
        }
      };
      
      xhr.onerror = function() {
        loadingDiv.style.display = 'none';
        updateStatus('Erro de conexão. Tentando método alternativo...');
        // Tentar método alternativo
        sendDataAlternative(data);
      };
      
      xhr.send(JSON.stringify(data));
    } catch(e) {
      console.error("Erro ao enviar dados:", e);
      loadingDiv.style.display = 'none';
      updateStatus('Erro ao enviar dados. Tentando método alternativo...');
      // Tentar método alternativo
      sendDataAlternative(data);
    }
  }
  
  // Método alternativo para enviar dados (mais compatível com dispositivos antigos)
  function sendDataAlternative(data) {
    // Mostrar indicador de carregamento
    loadingDiv.style.display = 'block';
    
    // Criar um iframe oculto
    var iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    document.body.appendChild(iframe);
    
    // Criar um formulário dentro do iframe
    var html = '<form id="form" method="POST" action="' + URL + '">';
    html += '<input type="hidden" name="data" value=\'' + JSON.stringify(data) + '\'>';
    html += '</form>';
    html += '<script>document.getElementById("form").submit();<\/script>';
    
    // Configurar callbacks
    iframe.onload = function() {
      loadingDiv.style.display = 'none';
      updateStatus('Registo guardado com sucesso!');
      removeFromOfflineData(data);
      
      // Remover o iframe após um curto período
      setTimeout(function() {
        try {
          document.body.removeChild(iframe);
        } catch(e) {
          console.error("Erro ao remover iframe:", e);
        }
      }, 1000);
    };
    
    iframe.onerror = function() {
      loadingDiv.style.display = 'none';
      updateStatus('Erro de conexão. Dados guardados localmente.');
    };
    
    // Definir um timeout para esconder o indicador de carregamento caso demore muito
    setTimeout(function() {
      loadingDiv.style.display = 'none';
    }, 5000);
    
    // Escrever o HTML no iframe
    try {
      var doc = iframe.contentWindow.document;
      doc.open();
      doc.write(html);
      doc.close();
    } catch(e) {
      console.error("Erro ao escrever no iframe:", e);
      loadingDiv.style.display = 'none';
      updateStatus('Erro ao enviar dados. Serão enviados mais tarde.');
    }
  }
  
  // Salvar dados offline para envio posterior
  function saveOfflineData(data) {
    var offlineData = localStorage.getItem('offlineData');
    var dataArray = offlineData ? JSON.parse(offlineData) : [];
    dataArray.push(data);
    localStorage.setItem('offlineData', JSON.stringify(dataArray));
  }
  
  // Remover dados do armazenamento offline
  function removeFromOfflineData(data) {
    var offlineData = localStorage.getItem('offlineData');
    if (!offlineData) return;
    
    var dataArray = JSON.parse(offlineData);
    // Filtrar para remover o item que acabou de ser enviado com sucesso
    var newArray = dataArray.filter(function(item) {
      if (item.funcionario === data.funcionario && 
          item.inicio === data.inicio &&
          item.fim === data.fim) {
        return false; // Remover este item
      }
      return true; // Manter este item
    });
    
    localStorage.setItem('offlineData', JSON.stringify(newArray));
  }
  
  // Tentar enviar dados offline
  function trySendOfflineData() {
    var offlineData = localStorage.getItem('offlineData');
    if (offlineData) {
      var dataArray = JSON.parse(offlineData);
      if (dataArray.length > 0) {
        // Tentar enviar o primeiro item
        sendData(dataArray[0]);
      }
    }
  }
  
  // Atualizar mensagem de status
  function updateStatus(message) {
    statusDiv.textContent = message;
    statusDiv.className = 'status active';
    
    setTimeout(function() {
      statusDiv.className = 'status';
    }, 5000);
  }
  
  // Inicializar
  loadState();
  setupButtons();
  
  // Verificar dados offline a cada minuto
  setInterval(trySendOfflineData, 60000);
})();
</script>
