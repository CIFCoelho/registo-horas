<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Registo Horário</title>
<style>
  body {
    font-family: sans-serif;
    max-width: 480px;
    margin: 0 auto;
    padding: 1rem;
    text-align: center;
  }
  .employee-button {
    width: 90%;
    height: 80px;
    margin: 15px auto;
    font-size: 24px;
    border-radius: 10px;
    background-color: #4285f4;
    color: white;
    border: none;
  }
  .employee-button.active {
    background-color: #34a853;
  }
  .status {
    margin-top: 20px;
    padding: 10px;
    border-radius: 5px;
    font-weight: bold;
  }
  .active {
    background-color: #d4edda;
    color: #155724;
  }
  #loading {
    display: none;
    margin: 20px auto;
    font-style: italic;
  }
</style>

<h1>Registo Horário - Estofagem</h1>
<div id="employee-buttons">
  <!-- Buttons will be added dynamically -->
</div>
<div id="status" class="status"></div>
<div id="loading">A processar...</div>

<script>
(function() {
  // URL do Google Apps Script (use JSONP format for better compatibility)
  var BASE_URL = "https://script.google.com/macros/s/AKfycbxbv3rV0rBWHvBuypZGg-uCk0JRqg5dDeHJgiz1383B_JtgwndA1HON2r83xfJJ76Ul/exec";
  
  // Referência aos elementos
  var buttonsContainer = document.getElementById('employee-buttons');
  var statusDiv = document.getElementById('status');
  var loadingDiv = document.getElementById('loading');
  
  // Lista de funcionários
  var employees = [
    "Antónia",
    "Diana",
    "Teresa"
  ];
  
  // Estado atual
  var currentState = {};
  
  // Inicializar
  function init() {
    // Carregar estado atual do servidor
    loadCurrentState();
    
    // Criar botões para cada funcionário
    createButtons();
    
    // Verificar dados offline a cada 30 segundos (mais frequente para o iPad antigo)
    setInterval(sendOfflineData, 30000);
  }
  
  // Criar botões para cada funcionário
  function createButtons() {
    buttonsContainer.innerHTML = '';
    
    for (var i = 0; i < employees.length; i++) {
      var button = document.createElement('button');
      button.className = 'employee-button';
      button.setAttribute('data-name', employees[i]);
      button.textContent = employees[i];
      
      // Adicionar classe active se o funcionário estiver trabalhando
      if (currentState[employees[i]] && currentState[employees[i]].isWorking) {
        button.className += ' active';
      }
      
      button.onclick = handleButtonClick;
      buttonsContainer.appendChild(button);
    }
  }
  
  // Carregar estado atual do servidor
  function loadCurrentState() {
    // Primeiro tentar carregar do localStorage
    var savedState = localStorage.getItem('employeeState');
    if (savedState) {
      try {
        currentState = JSON.parse(savedState);
      } catch(e) {
        currentState = {};
      }
    }
    
    // Atualizar a interface com o estado atual
    updateButtonsState();
    
    // Fazer uma solicitação ao servidor para obter o estado mais recente
    var url = BASE_URL + "?action=getState&_=" + new Date().getTime();
    
    loadingDiv.style.display = 'block';
    
    // Usar um iframe para carregar dados (mais compatível com dispositivos antigos)
    var iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.onload = function() {
      loadingDiv.style.display = 'none';
      // Tentar ler a resposta do iframe
      try {
        setTimeout(function() {
          document.body.removeChild(iframe);
        }, 100);
      } catch(e) {
        console.log("Erro ao remover iframe:", e);
      }
    };
    
    iframe.src = url;
    document.body.appendChild(iframe);
    
    // Definir um timeout para esconder o indicador de carregamento caso demore muito
    setTimeout(function() {
      loadingDiv.style.display = 'none';
    }, 5000);
  }
  
  // Atualizar o estado visual dos botões
  function updateButtonsState() {
    var buttons = document.querySelectorAll('.employee-button');
    for (var i = 0; i < buttons.length; i++) {
      var name = buttons[i].getAttribute('data-name');
      if (currentState[name] && currentState[name].isWorking) {
        buttons[i].classList.add('active');
      } else {
        buttons[i].classList.remove('active');
      }
    }
  }
  
  // Manipular clique no botão
  function handleButtonClick() {
    var name = this.getAttribute('data-name');
    var isWorking = currentState[name] && currentState[name].isWorking;
    
    if (isWorking) {
      // Funcionário está a trabalhar, confirmar saída
      if (confirm('Quer terminar o período de trabalho na secção de estufagem?')) {
        endWork(name);
      }
    } else {
      // Funcionário não está a trabalhar, confirmar entrada
      if (confirm('Quer iniciar o período de trabalho na secção de estufagem?')) {
        startWork(name);
      }
    }
  }
  
  // Iniciar período de trabalho
  function startWork(name) {
    var now = new Date();
    var formattedTime = formatTime(now);
    
    // Atualizar estado local
    currentState[name] = {
      isWorking: true,
      startTime: now.toISOString()
    };
    
    // Salvar no localStorage
    localStorage.setItem('employeeState', JSON.stringify(currentState));
    
    // Atualizar interface
    updateButtonsState();
    updateStatus(name + ' iniciou trabalho às ' + formattedTime);
    
    // Enviar ao servidor
    var data = {
      action: 'startWork',
      funcionario: name,
      secao: 'Estufagem',
      inicio: formattedTime,
      timestamp: now.getTime()
    };
    
    sendToServer(data);
  }
  
  // Terminar período de trabalho
  function endWork(name) {
    if (!currentState[name] || !currentState[name].isWorking) {
      updateStatus('Erro: ' + name + ' não está em período de trabalho');
      return;
    }
    
    var now = new Date();
    var formattedTime = formatTime(now);
    var startTime = new Date(currentState[name].startTime);
    
    // Atualizar estado local
    currentState[name].isWorking = false;
    
    // Salvar no localStorage
    localStorage.setItem('employeeState', JSON.stringify(currentState));
    
    // Atualizar interface
    updateButtonsState();
    updateStatus(name + ' terminou trabalho às ' + formattedTime);
    
    // Enviar ao servidor - deixar o servidor calcular a duração
    var data = {
      action: 'endWork',
      funcionario: name,
      secao: 'Estufagem',
      inicio: formatTime(startTime),
      fim: formattedTime,
      startTimestamp: startTime.getTime(),
      endTimestamp: now.getTime()
    };
    
    sendToServer(data);
  }
  
  // Formatar hora como HH:MM
  function formatTime(date) {
    var hours = date.getHours().toString().padStart(2, '0');
    var minutes = date.getMinutes().toString().padStart(2, '0');
    return hours + ':' + minutes;
  }
  
  // Enviar dados para o servidor usando um método mais compatível
  function sendToServer(data) {
    // Salvar dados offline primeiro (garantia)
    saveOfflineData(data);
    
    // Construir URL com parâmetros
    var url = BASE_URL + "?data=" + encodeURIComponent(JSON.stringify(data)) + "&_=" + new Date().getTime();
    
    loadingDiv.style.display = 'block';
    
    // Usar um iframe para enviar dados (mais compatível com dispositivos antigos)
    var iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.onload = function() {
      loadingDiv.style.display = 'none';
      updateStatus('Operação registada com sucesso!');
      
      // Remover dos dados offline se bem sucedido
      removeFromOfflineData(data);
      
      // Remover o iframe
      try {
        setTimeout(function() {
          document.body.removeChild(iframe);
        }, 100);
      } catch(e) {
        console.log("Erro ao remover iframe:", e);
      }
    };
    
    iframe.onerror = function() {
      loadingDiv.style.display = 'none';
      updateStatus('Erro de conexão. Dados guardados localmente.');
    };
    
    iframe.src = url;
    document.body.appendChild(iframe);
    
    // Definir um timeout para esconder o indicador de carregamento caso demore muito
    setTimeout(function() {
      loadingDiv.style.display = 'none';
    }, 5000);
  }
  
  // Salvar dados offline para envio posterior
  function saveOfflineData(data) {
    var offlineData = localStorage.getItem('offlineData');
    var dataArray = offlineData ? JSON.parse(offlineData) : [];
    dataArray.push({
      data: data,
      timestamp: new Date().getTime()
    });
    localStorage.setItem('offlineData', JSON.stringify(dataArray));
  }
  
  // Remover dados do armazenamento offline
  function removeFromOfflineData(data) {
    var offlineData = localStorage.getItem('offlineData');
    if (!offlineData) return;
    
    var dataArray = JSON.parse(offlineData);
    // Filtrar para remover o item que acabou de ser enviado com sucesso
    dataArray = dataArray.filter(function(item) {
      return item.data.funcionario !== data.funcionario || 
             item.data.action !== data.action ||
             item.data.timestamp !== data.timestamp;
    });
    
    localStorage.setItem('offlineData', JSON.stringify(dataArray));
  }
  
  // Enviar dados offline
  function sendOfflineData() {
    var offlineData = localStorage.getItem('offlineData');
    if (!offlineData) return;
    
    var dataArray = JSON.parse(offlineData);
    if (dataArray.length === 0) return;
    
    // Ordenar por timestamp para enviar os mais antigos primeiro
    dataArray.sort(function(a, b) {
      return a.timestamp - b.timestamp;
    });
    
    // Enviar o primeiro item
    var firstItem = dataArray[0];
    
    // Construir URL com parâmetros
    var url = BASE_URL + "?data=" + encodeURIComponent(JSON.stringify(firstItem.data)) + 
              "&offline=true&_=" + new Date().getTime();
    
    // Usar um iframe para enviar dados
    var iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    iframe.onload = function() {
      // Remover o item enviado da lista
      dataArray.shift();
      localStorage.setItem('offlineData', JSON.stringify(dataArray));
      
      // Remover o iframe
      try {
        setTimeout(function() {
          document.body.removeChild(iframe);
        }, 100);
      } catch(e) {
        console.log("Erro ao remover iframe:", e);
      }
      
      // Se ainda houver mais itens, continuar enviando
      if (dataArray.length > 0) {
        setTimeout(sendOfflineData, 3000);
      }
    };
    
    iframe.src = url;
    document.body.appendChild(iframe);
  }
  
  // Atualizar mensagem de status
  function updateStatus(message) {
    statusDiv.textContent = message;
    statusDiv.className = 'status active';
    
    setTimeout(function() {
      statusDiv.className = 'status';
    }, 5000);
  }
  
  // Iniciar a aplicação
  init();
})();
</script>
