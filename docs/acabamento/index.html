<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>Registo OF - Acabamento</title>
<style>
  body {
    font-family: sans-serif;
    max-width: 480px;
    margin: 0 auto;
    padding: 1rem;
    text-align: center;
  }
  .employee-button, #change-of-button {
    width: 90%;
    height: 80px;
    margin: 15px auto;
    font-size: 24px;
    border-radius: 10px;
    background-color: #4285f4;
    color: white;
    border: none;
  }
  .employee-button.active {
    background-color: #34a853;
  }
  #of-input {
    width: 60%;
    font-size: 24px;
    margin-bottom: 15px;
    text-align: center;
  }
  .status {
    margin-top: 20px;
    padding: 10px;
    border-radius: 5px;
    font-weight: bold;
  }
  .active {
    background-color: #d4edda;
    color: #155724;
  }
  #loading {
    display: none;
    margin: 20px auto;
    font-style: italic;
  }
</style>

<h1>Registo OF - Acabamento</h1>
<input type="number" id="of-input" placeholder="Nº OF">
<div id="employee-buttons">
  <button class="employee-button" data-name="Joana">Joana</button>
  <button class="employee-button" data-name="Maria">Maria</button>
</div>
<button id="change-of-button">Mudar de OF</button>
<div id="status" class="status"></div>
<div id="loading">A processar...</div>

<script>
(function() {
  var URL = "https://script.google.com/macros/s/YOUR_DEPLOYMENT_ID_HERE/exec";
  var buttons = document.querySelectorAll('.employee-button');
  var statusDiv = document.getElementById('status');
  var loadingDiv = document.getElementById('loading');
  var ofInput = document.getElementById('of-input');
  var changeOFBtn = document.getElementById('change-of-button');
  var breakPeriods = [
    { start: '10:00', end: '10:10' },
    { start: '12:00', end: '13:00' }
  ];
  var employees = {};

  function loadState() {
    try {
      var saved = localStorage.getItem('employeeStateOF');
      if (saved) {
        employees = JSON.parse(saved);
        updateButtons();
      }
    } catch (e) {
      employees = {};
    }
  }

  function saveState() {
    try {
      localStorage.setItem('employeeStateOF', JSON.stringify(employees));
    } catch (e) {
      updateStatus('Erro ao guardar estado: ' + e.message);
    }
  }

  function updateButtons() {
    for (var i = 0; i < buttons.length; i++) {
      var name = buttons[i].getAttribute('data-name');
      if (employees[name] && employees[name].isWorking) {
        buttons[i].className = 'employee-button active';
      } else {
        buttons[i].className = 'employee-button';
      }
    }
  }

  function handleButtonClick() {
    var name = this.getAttribute('data-name');
    var of = ofInput.value;
    if (!of) return updateStatus('Insere o Nº da OF.');

    var now = new Date();
    if (!employees[name] || !employees[name].isWorking) {
      employees[name] = {
        isWorking: true,
        startTime: now.toISOString(),
        of: of
      };
      updateStatus(name + ' iniciou trabalho na OF ' + of + ' às ' + formatTime(now));
    } else {
      sendPeriod(name, employees[name].of, employees[name].startTime, now);
      employees[name] = null;
      updateStatus(name + ' terminou trabalho às ' + formatTime(now));
    }
    saveState();
    updateButtons();
  }

  function handleChangeOF() {
    var of = ofInput.value;
    if (!of) return updateStatus('Insere o novo Nº da OF.');

    var now = new Date();
    for (var name in employees) {
      if (employees[name] && employees[name].isWorking) {
        sendPeriod(name, employees[name].of, employees[name].startTime, now);
        employees[name] = {
          isWorking: true,
          startTime: now.toISOString(),
          of: of
        };
        updateStatus(name + ' mudou para OF ' + of + ' às ' + formatTime(now));
      }
    }
    saveState();
    updateButtons();
  }

  function sendPeriod(name, of, startIso, end) {
    var start = new Date(startIso);
    var duration = calculateDuration(start, end);
    var data = {
      funcionario: name,
      secao: 'Acabamento',
      of: of,
      inicio: formatTime(start),
      fim: formatTime(end),
      duracao: duration
    };
    sendData(data);
  }

  function calculateDuration(start, end) {
    var minutes = 0;
    var current = new Date(start);
    while (current < end) {
      var time = formatTime(current);
      var inBreak = false;
      for (var i = 0; i < breakPeriods.length; i++) {
        var b = breakPeriods[i];
        if (time >= b.start && time < b.end) {
          inBreak = true;
          break;
        }
      }
      if (!inBreak) minutes++;
      current.setTime(current.getTime() + 60000);
    }
    return (minutes / 60).toFixed(2);
  }

  function formatTime(d) {
    var h = d.getHours();
    var m = d.getMinutes();
    return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
  }

  function sendData(data) {
    loadingDiv.style.display = 'block';
    var encoded = 'data=' + encodeURIComponent(JSON.stringify(data));
    var xhr = new XMLHttpRequest();
    xhr.open('POST', URL, true);
    xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
    xhr.onload = function() {
      loadingDiv.style.display = 'none';
      var response = xhr.responseText ? xhr.responseText.trim() : '';
      updateStatus(xhr.status === 200 ? 'Registo guardado com sucesso!' : 'Erro: ' + response);
    };
    xhr.onerror = function() {
      loadingDiv.style.display = 'none';
      updateStatus('Erro de rede.');
    };
    xhr.send(encoded);
  }

  function updateStatus(msg) {
    statusDiv.textContent = msg;
    statusDiv.className = 'status active';
    setTimeout(function() {
      statusDiv.className = 'status';
    }, 5000);
  }

  for (var i = 0; i < buttons.length; i++) {
    buttons[i].addEventListener('click', handleButtonClick, false);
  }
  changeOFBtn.addEventListener('click', handleChangeOF, false);
  loadState();
})();

</script>