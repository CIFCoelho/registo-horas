<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Estofagem</title>
  <style>
    body {
      font-family: sans-serif;
      max-width: 480px;
      margin: 0 auto;
      padding: 1rem;
      text-align: center;
    }
    .employee {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 15px auto;
      padding: 1rem;
      border-radius: 12px;
      font-size: 22px;
      background-color: #4285f4;
      color: white;
      width: 90%;
    }
    .employee.active {
      background-color: #34a853;
    }
    .of-display {
      font-weight: bold;
      font-size: 20px;
      background-color: white;
      color: black;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      line-height: 50px;
      text-align: center;
      cursor: pointer;
    }
    #of-keypad {
      display: none;
      margin: 1rem auto;
    }
    .key {
      display: inline-block;
      width: 60px;
      height: 60px;
      margin: 5px;
      font-size: 24px;
      border: none;
      border-radius: 8px;
      background: #eee;
      cursor: pointer;
    }
    #status {
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Estofagem</h1>
  <div id="employee-list"></div>
  <div id="of-keypad"></div>
  <div id="status"></div>

  <script>
  (function() {
    var URL = "https://script.google.com/macros/s/AKfycbxf1CJR2OG2Io90pVLmDqHPc34dj6bicxUQtL48vKVaUlsua2OZZQsoDM7uXpgjQbL5/exec";
    var names = ["Antónia", "Diana", "Teresa"];
    var breakPeriods = [
      { start: '10:00', end: '10:10' },
      { start: '12:00', end: '13:00' }
    ];
    var employees = {};
    var selectedOFChange = null;

    var listDiv = document.getElementById('employee-list');
    var keypadDiv = document.getElementById('of-keypad');
    var statusDiv = document.getElementById('status');

    function renderButtons() {
      listDiv.innerHTML = '';
      for (var i = 0; i < names.length; i++) {
        var name = names[i];
        var state = employees[name];
        var div = document.createElement('div');
        div.className = 'employee' + (state && state.isWorking ? ' active' : '');

        var span = document.createElement('span');
        span.textContent = name;
        span.onclick = makeNameClick(name);
        div.appendChild(span);

        var of = document.createElement('div');
        of.className = 'of-display';
        of.textContent = state && state.of ? state.of : '+';
        of.onclick = makeOFClick(name);
        div.appendChild(of);

        listDiv.appendChild(div);
      }
    }

    function makeNameClick(name) {
      return function() {
        var now = new Date();
        var state = employees[name];
        if (!state || !state.isWorking) {
          selectedOFChange = name;
          showKeypad();
        } else {
          sendRecord(name, state.of, state.startTime, now);
          employees[name] = null;
          saveState();
          renderButtons();
          updateStatus(name + ' terminou turno.');
        }
      };
    }

    function makeOFClick(name) {
      return function() {
        var state = employees[name];
        if (state && state.isWorking) {
          selectedOFChange = name;
          showKeypad();
        }
      };
    }

    function showKeypad() {
    var html = '<div id="of-display" style="font-size: 32px; margin-bottom: 10px;">OF: </div>';
    for (var i = 1; i <= 9; i++) html += '<button class="key">' + i + '</button>';
    html += '<br><button class="key">0</button>';
    html += '<button class="key" id="del">DEL</button>';
    html += '<button class="key" id="ok">OK</button>';
    keypadDiv.innerHTML = html;
    keypadDiv.style.display = 'block';

    var input = '';
    var display = document.getElementById('of-display');
    var keys = keypadDiv.querySelectorAll('.key');
    for (var i = 0; i < keys.length; i++) {
      keys[i].onclick = function() {
        var val = this.textContent;
        if (val === 'DEL') {
          input = input.slice(0, -1);
        } else if (val === 'OK') {
          if (!input) return;
          var now = new Date();
          var state = employees[selectedOFChange];
          if (state && state.isWorking) {
            sendRecord(selectedOFChange, state.of, state.startTime, now);
          }
          employees[selectedOFChange] = {
            isWorking: true,
            startTime: now.toISOString(),
            of: input
          };
          saveState();
          renderButtons();
          keypadDiv.style.display = 'none';
          updateStatus(selectedOFChange + ' iniciou OF ' + input);
        } else {
          input += val;
        }
        display.textContent = 'OF: ' + input;
      };
    }
  }

    function sendRecord(name, of, startISO, endDate) {
      var start = new Date(startISO);
      var duration = calculateDuration(start, endDate);
      var data = {
        funcionario: name,
        secao: 'Estofagem',
        of: of,
        inicio: formatTime(start),
        fim: formatTime(endDate),
        duracao: duration
      };
      sendData(data);
    }

    function calculateDuration(start, end) {
      var mins = 0;
      var cur = new Date(start);
      while (cur < end) {
        var time = formatTime(cur);
        var isBreak = false;
        for (var i = 0; i < breakPeriods.length; i++) {
          var b = breakPeriods[i];
          if (time >= b.start && time < b.end) {
            isBreak = true;
            break;
          }
        }
        if (!isBreak) mins++;
        cur.setTime(cur.getTime() + 60000);
      }
      return (mins / 60).toFixed(2);
    }

    function formatTime(d) {
      var h = d.getHours();
      var m = d.getMinutes();
      return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
    }

    function sendData(data) {
      var encoded = 'data=' + encodeURIComponent(JSON.stringify(data));
      var xhr = new XMLHttpRequest();
      xhr.open('POST', URL, true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.onload = function() {
        updateStatus(xhr.status === 200 ? '✔ Registo enviado' : 'Erro: ' + xhr.responseText);
      };
      xhr.onerror = function() {
        updateStatus('Erro de rede.');
      };
      xhr.send(encoded);
    }

    function updateStatus(msg) {
      statusDiv.textContent = msg;
      setTimeout(function() { statusDiv.textContent = ''; }, 4000);
    }

    function saveState() {
      try {
        localStorage.setItem('stateEstofagem', JSON.stringify(employees));
      } catch (e) {}
    }

    function loadState() {
      try {
        var data = localStorage.getItem('stateEstofagem');
        if (data) employees = JSON.parse(data);
      } catch (e) {}
    }

    loadState();
    renderButtons();
  })();
  </script>
</body>
</html>