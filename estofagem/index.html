<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Estofagem</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    #container {
      display: flex;
      flex-direction: row;
      max-width: 480px;
      margin: 0 auto;
      padding: 1rem;
      box-sizing: border-box;
    }
    #employee-list {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    .employee {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem;
      border-radius: 12px;
      font-size: 22px;
      background-color: #4285f4;
      color: white;
      width: 100%;
      box-sizing: border-box;
      cursor: pointer;
    }
    .employee.active {
      background-color: #34a853;
    }
    .employee.selected {
      background-color: #6c757d;
    }
    .of-display {
      font-weight: bold;
      font-size: 20px;
      background-color: white;
      color: black;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      line-height: 60px;
      text-align: center;
      cursor: pointer;
    }
    #of-keypad {
      flex: 1;
      text-align: center;
      display: none;
    }
    .key-row {
      display: flex;
      justify-content: center;
      margin: 5px 0;
    }
    .key {
      width: 60px;
      height: 60px;
      font-size: 24px;
      margin: 4px;
      border: none;
      border-radius: 8px;
      background: #eee;
      cursor: pointer;
    }
    .key.wide {
      width: 90px;
    }
    #of-display {
      font-size: 28px;
      margin-bottom: 10px;
    }
    #cancel-btn {
      font-size: 22px;
      margin: 10px;
      padding: 0.5rem 1rem;
      background-color: #dc3545;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #status {
      text-align: center;
      margin: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1 style="text-align:center;">Estofagem</h1>
  <div id="container">
    <div id="employee-list"></div>
    <div id="of-keypad"></div>
  </div>
  <div id="status"></div>

  <script>
  (function() {
    var URL = "https://script.google.com/macros/s/AKfycbxf1CJR2OG2Io90pVLmDqHPc34dj6bicxUQtL48vKVaUlsua2OZZQsoDM7uXpgjQbL5/exec";
    var names = ["Antónia", "Diana", "Teresa"];
    var breakPeriods = [
      { start: '10:00', end: '10:10' },
      { start: '12:00', end: '13:00' }
    ];
    var employees = {};
    var selectedOFChange = null;

    var listDiv = document.getElementById('employee-list');
    var keypadDiv = document.getElementById('of-keypad');
    var statusDiv = document.getElementById('status');

    function renderButtons() {
      listDiv.innerHTML = '';
      for (var i = 0; i < names.length; i++) {
        var name = names[i];
        var state = employees[name];
        var div = document.createElement('div');
        div.className = 'employee';
        if (state && state.isWorking) div.classList.add('active');
        if (selectedOFChange === name) div.classList.add('selected');
        div.onclick = makeNameClick(name);

        var span = document.createElement('span');
        span.textContent = name;
        div.appendChild(span);

        var of = document.createElement('div');
        of.className = 'of-display';
        of.textContent = state && state.of ? state.of : '+';
        of.onclick = makeOFClick(name);
        div.appendChild(of);

        listDiv.appendChild(div);
      }
    }

    function makeNameClick(name) {
      return function(event) {
        if (event.target.className.indexOf('of-display') !== -1) return;
        var now = new Date();
        var state = employees[name];
        if (!state || !state.isWorking) {
          selectedOFChange = name;
          renderButtons();
          showKeypad();
        } else {
          sendRecord(name, state.of, state.startTime, now);
          employees[name] = null;
          saveState();
          renderButtons();
          updateStatus(name + ' terminou turno.');
        }
      };
    }

    function makeOFClick(name) {
      return function() {
        var state = employees[name];
        if (state && state.isWorking) {
          selectedOFChange = name;
          renderButtons();
          showKeypad();
        }
      };
    }

    function showKeypad() {
      var input = '';
      keypadDiv.style.display = 'block';
      var html = '<div id="of-display">OF: </div>';
      var layout = [
        ['1','2','3'],
        ['4','5','6'],
        ['7','8','9'],
        ['DEL','0','OK']
      ];

      for (var r = 0; r < layout.length; r++) {
        html += '<div class="key-row">';
        for (var c = 0; c < layout[r].length; c++) {
          var val = layout[r][c];
          var cls = 'key';
          if (val === 'DEL' || val === 'OK') cls += ' wide';
          html += '<button class="' + cls + '">' + val + '</button>';
        }
        html += '</div>';
      }
      html += '<button id="cancel-btn">↩ Cancelar</button>';
      keypadDiv.innerHTML = html;

      var display = document.getElementById('of-display');
      var cancelBtn = document.getElementById('cancel-btn');
      cancelBtn.onclick = function() {
        selectedOFChange = null;
        keypadDiv.style.display = 'none';
        renderButtons();
      };

      var keys = keypadDiv.querySelectorAll('.key');
      for (var i = 0; i < keys.length; i++) {
        keys[i].onclick = function() {
          var val = this.textContent;
          if (val === 'DEL') {
            input = input.slice(0, -1);
          } else if (val === 'OK') {
            if (!input) return;
            var now = new Date();
            var state = employees[selectedOFChange];
            if (state && state.isWorking) {
              sendRecord(selectedOFChange, state.of, state.startTime, now);
            }
            employees[selectedOFChange] = {
              isWorking: true,
              startTime: now.toISOString(),
              of: input
            };
            saveState();
            keypadDiv.style.display = 'none';
            selectedOFChange = null;
            renderButtons();
            updateStatus(selectedOFChange + ' iniciou OF ' + input);
          } else {
            input += val;
          }
          display.textContent = 'OF: ' + input;
        };
      }
    }

    function sendRecord(name, of, startISO, endDate) {
      var start = new Date(startISO);
      var duration = calculateDuration(start, endDate);
      var data = {
        funcionario: name,
        secao: 'Estofagem',
        of: of,
        inicio: formatTime(start),
        fim: formatTime(endDate),
        duracao: duration
      };
      sendData(data);
    }

    function calculateDuration(start, end) {
      var mins = 0;
      var cur = new Date(start);
      while (cur < end) {
        var time = formatTime(cur);
        var isBreak = false;
        for (var i = 0; i < breakPeriods.length; i++) {
          var b = breakPeriods[i];
          if (time >= b.start && time < b.end) {
            isBreak = true;
            break;
          }
        }
        if (!isBreak) mins++;
        cur.setTime(cur.getTime() + 60000);
      }
      return (mins / 60).toFixed(2);
    }

    function formatTime(d) {
      var h = d.getHours();
      var m = d.getMinutes();
      return (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
    }

    function sendData(data) {
      var encoded = 'data=' + encodeURIComponent(JSON.stringify(data));
      var xhr = new XMLHttpRequest();
      xhr.open('POST', URL, true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.onload = function() {
        updateStatus(xhr.status === 200 ? 'Registo enviado' : 'Erro: ' + xhr.responseText);
      };
      xhr.onerror = function() {
        updateStatus('Erro de rede.');
      };
      xhr.send(encoded);
    }

    function updateStatus(msg) {
      statusDiv.textContent = msg;
      setTimeout(function() { statusDiv.textContent = ''; }, 4000);
    }

    function saveState() {
      try {
        localStorage.setItem('stateEstofagem', JSON.stringify(employees));
      } catch (e) {}
    }

    function loadState() {
      try {
        var data = localStorage.getItem('stateEstofagem');
        if (data) employees = JSON.parse(data);
      } catch (e) {}
    }

    loadState();
    renderButtons();
  })();
  </script>
</body>
</html>
